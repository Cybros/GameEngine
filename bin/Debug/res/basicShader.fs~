#version 420

const int MAX = 4;
in vec2 texCoord0;
in vec3 normal0;
in vec3 worldPos0;

uniform sampler2D sampler;
uniform vec4 MaterialAmbientColor;
uniform vec3 eyePos;

struct BaseLight
{
	vec3 color;
	float intensity;
};
struct DirectionalLight
{
	BaseLight base;
	vec3 direction;
};

struct Attenuation
{
	float constant;
	float linear;
	float exponent;
};
struct PointLight
{
	BaseLight base;
	vec3 position;
	Attenuation atten;
};
vec4 calcLightDiffuse(BaseLight base , vec3 direction , vec3 normal)
{
	float diffuseFactor = dot(normal , -direction);
	vec4 diffuseColor = vec4(0,0,0,0);
	vec4 specularColor = vec4(0,0,0,0);
	
	if(diffuseFactor > 0)
	{
		diffuseColor = vec4(base.color,1)*base.intensity*diffuseFactor;
	}
	return diffuseColor;
}
vec4 calcLightSpec(BaseLight base , vec3 direction , vec3 normal)
{
	vec3 directionToEye = normalize(eyePos-worldPos0);
	vec3 reflectDirection = normalize(reflect(direction , normal));
	vec4 specularColor = vec4(0,0,0,0);

	float specularFactor = dot(directionToEye , reflectDirection);
	if(specularFactor > 0 && dot(normal , -direction)>0)
	{
		specularFactor = pow(specularFactor , 11);
		specularColor = vec4(base.color , 1.0)*specularFactor*10;
	}
	return specularColor;
}
vec4 calcLightDirectionDiffuse(DirectionalLight dirlight , vec3 normal)
{
	return calcLightDiffuse(dirlight.base , dirlight.direction , normal);
}
vec4 calcLightDirectionSpec(DirectionalLight dirlight , vec3 normal)
{
	return calcLightSpec(dirlight.base , dirlight.direction , normal);
}

vec4 calcPointLightDiffuse(PointLight point , vec3 normal)
{
	vec3 lightDirection = worldPos0 - point.position;
	float distanceToPoint = length(lightDirection);
	lightDirection = normalize(lightDirection);
	vec4 color = calcLightDiffuse(point.base , lightDirection , normal);

	float attenu = point.atten.constant + point.atten.linear*distanceToPoint
		       + point.atten.exponent*distanceToPoint*distanceToPoint + 0.001;
	
	return color/attenu;
	
}
vec4 calcPointLightSpec(PointLight point , vec3 normal)
{
	vec3 lightDirection = worldPos0 - point.position;
	float distanceToPoint = length(lightDirection);
	lightDirection = normalize(lightDirection);
	vec4 color = calcLightSpec(point.base , lightDirection , normal);

	float attenu = point.atten.constant + point.atten.linear*distanceToPoint
		       + point.atten.exponent*distanceToPoint*distanceToPoint + 0.001;
	
	return color/attenu;
	
}

void main()
{
	PointLight p1;
	Attenuation  a1;
	a1.constant = 0;
	a1.linear = 0;
	a1.exponent = 1;
	p1.base.color = vec3(1.0f , 1.0f , 1.0f);
	p1.base.intensity = 5.0f;
	p1.atten = a1;
	p1.position = vec3(0.0 , 6.0 , 2.0);
	
	vec4 plightdiff = calcPointLightDiffuse(p1 , normalize(normal0));
	vec4 plightspec = calcPointLightSpec(p1 , normalize(normal0));
	
	gl_FragColor =  plightspec ;
	//texture2D(sampler, texCoord0.xy)
		
}
